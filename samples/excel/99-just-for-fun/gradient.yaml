order: 2
id: excel-just-for-fun-gradient
name: Gradient
description: Uses range formatting and external libraries to draw a colorful gradient within a range. Contributed by Alexander Zlatkovski.
author: AlexanderZlatkovski
host: EXCEL
api_set:
    ExcelApi: '1.4'
script:
    content: |-
        // Set up the click handler.
        document.getElementById("draw-gradient").addEventListener("click", drawGradient);
        document.getElementById("random").addEventListener("click", randomizeColors);

        /** Click-handler for drawing the gradient. */
        async function drawGradient() {
            const drawButton = document.getElementById("draw-gradient") as HTMLButtonElement;
            drawButton.disabled = true;

            try {
                await Excel.run(drawGradientHelper);
            } catch (error) {
                console.log(error);
            }

            drawButton.disabled = false;
        }

        /** Helper function to do the actual gradient-drawing. */
        async function drawGradientHelper(context: Excel.RequestContext) {
            context.workbook.worksheets.getItemOrNullObject("Gradient").delete();
            const sheet = context.workbook.worksheets.add("Gradient");

            sheet.getRange().untrack().format.set({
                rowHeight: 15,
                columnWidth: 15,
                fill: {
                    color: "#1e1e1e"
                }
            });

            let originalSize = parseInt((document.getElementById("size") as HTMLInputElement).value);
            const colors2D = createColorArray(originalSize);

            // Retrieve color values from <input type="color"> elements.
            const topLeftColor = (document.getElementById("top-left") as HTMLInputElement).value;
            const topRightColor = (document.getElementById("top-right") as HTMLInputElement).value;
            const bottomLeftColor = (document.getElementById("bottom-left") as HTMLInputElement).value;
            const bottomRightColor = (document.getElementById("bottom-right") as HTMLInputElement).value;

            // Convert HEX colors to RGB.
            const topLeftRgb = hexToRgb(topLeftColor);
            const topRightRgb = hexToRgb(topRightColor);
            const bottomLeftRgb = hexToRgb(bottomLeftColor);
            const bottomRightRgb = hexToRgb(bottomRightColor);

            if (Office.context.requirements.isSetSupported("ExcelApi", "1.9")) {
                // ExcelApi 1.9 introduced the setCellProperties APIs to efficiently set different properties
                // across a range without needing to iterate cell-by-cell.
                const cellProperties: Excel.SettableCellProperties[][] =
                colors2D.map(row =>
                    row.map(color =>
                        ({
                            format: {
                                fill: {
                                    color: color
                                }
                            }
                        })
                    )
                );
                sheet.getRangeByIndexes(1, 1, originalSize, originalSize).setCellProperties(cellProperties);
            } else {
                let range = sheet.getCell(1, 1).untrack().getResizedRange(originalSize - 1, originalSize - 1).untrack();
                for (let row = 0; row < originalSize; row++) {
                    for (let col = 0; col < originalSize; col++) {
                        range.getCell(row, col).untrack().format.fill.color = colors2D[row][col];
                    }
                }
            }

            sheet.activate();
            await context.sync();
        }

        function createColorArray(size: number): string[][] {
            // Create a 2D in-memory array to hold the colors.
            let colors2D = Array(size);
            for (let row = 0; row < size; row++) {
                colors2D[row] = Array(size);
            }

            // Get the color values from the color pickers.
            const topLeftColor = (document.getElementById("top-left") as HTMLInputElement).value;
            const topRightColor = (document.getElementById("top-right") as HTMLInputElement).value;
            const bottomLeftColor = (document.getElementById("bottom-left") as HTMLInputElement).value;
            const bottomRightColor = (document.getElementById("bottom-right") as HTMLInputElement).value;

            // Convert HEX to RGB.
            const topLeftRgb = hexToRgb(topLeftColor);
            const topRightRgb = hexToRgb(topRightColor);
            const bottomLeftRgb = hexToRgb(bottomLeftColor);
            const bottomRightRgb = hexToRgb(bottomRightColor);

            const topColors = getColorsArray(
                topLeftRgb,
                topRightRgb,
                size
            );

            const bottomColors = getColorsArray(
                bottomLeftRgb,
                bottomRightRgb,
                size
            );

            for (let col = 0; col < size; col++) {
                const columnColors = getColorsArray(topColors[col], bottomColors[col], size);
                for (let row = 0; row < size; row++) {
                    colors2D[row][col] = rgbToHex(columnColors[row]);
                }
            }

            return colors2D;
        }

        /** Helper function to get an array of colors. */
        function getColorsArray(color1, color2, count: number) {
            const result = new Array(count);
            for (let i = 0; i < count; i++) {
                const fraction = i / (count - 1);
                result[i] = {
                    r: color1.r + (color2.r - color1.r) * fraction,
                    g: color1.g + (color2.g - color1.g) * fraction,
                    b: color1.b + (color2.b - color1.b) * fraction
                };
            }
            return result;
        }

        /** Helper function to convert HEX color to RGB object */
        function hexToRgb(hex: string): { r: number; g: number; b: number } {
            // Remove the hash if present
            hex = hex.replace(/^#/, '');
            
            // Parse the hex values
            const bigint = parseInt(hex, 16);
            return {
                r: (bigint >> 16) & 255,
                g: (bigint >> 8) & 255,
                b: bigint & 255
            };
        }

        /** Helper function to convert RGB object to HEX string */
        function rgbToHex(rgb: { r: number; g: number; b: number }): string {
            const r = Math.round(rgb.r).toString(16).padStart(2, '0');
            const g = Math.round(rgb.g).toString(16).padStart(2, '0');
            const b = Math.round(rgb.b).toString(16).padStart(2, '0');
            return `#${r}${g}${b}`;
        }

        /** Helper function to generate random HEX color */
        function randomColor(): string {
            const r = Math.floor(Math.random() * 256).toString(16).padStart(2, '0');
            const g = Math.floor(Math.random() * 256).toString(16).padStart(2, '0');
            const b = Math.floor(Math.random() * 256).toString(16).padStart(2, '0');
            return `#${r}${g}${b}`;
        }

        function randomizeColors() {
            // Select all color input elements.
            const colorInputs = document.querySelectorAll("#color-table input[type='color']");
            
            // Iterate through each color input and set a random color.
            colorInputs.forEach((input) => {
                (input as HTMLInputElement).value = randomColor();
            });
        }
    language: typescript
template:
    content: |-
        <header>
            <h2>Color configuration</h2>
        </header>
        <section>
            <div id="color-table">
                <div>Top left</div>
                <table>
                    <tr>
                        <td><input id="top-left" type="color" value="#ff0000" /></td>
                        <td><input id="top-right" type="color" value="#00ff00" /></td>
                    </tr>
                    <tr>
                        <td><input id="bottom-left" type="color" value="#0000ff" /></td>
                        <td><input id="bottom-right" type="color" value="#ffff00" /></td>
                    </tr>
                </table>
                <div>
                    Bottom right
                </div>
            </div>
            <button id="random">Randomize colors</button>
            <h2>Size
                <span>(width x height)</span>
            </h2>
            <input id="size" type="range" value="25" min="2" max="100">
            <button id="draw-gradient">
                <span>Draw gradient</span>
            </button>
            <div id="credits">
                <div>
                    Uses native JavaScript color conversions.
                </div>
            </div>
        </section>
    language: html
style:
    content: |-
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            padding: 10px;
        }

        button {
            background-color: #f0f0f0;
            color: #333333;
            border: 1px solid #8a8a8a;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 2px;
            margin-left: 20px;
            margin-bottom: 5px;
            min-width: 80px;
            display: block;
        }

        button:hover {
            background-color: #e0e0e0;
        }

        button:active {
            background-color: #d0d0d0;
        }

        h2:not(:first-child) {
            margin-top: 35px;
        }

        #color-table {
            width: 130px;
            margin-bottom: 20px;
        }

            #color-table table {
                width: 100%;
            }

            #color-table td:nth-child(2),
            #color-table div:last-child {
                text-align: right;
            }

        #credits {
            margin-top: 60px;
            padding: 10px;
            background: linear-gradient(rgb(150, 150, 200), white);
        }

            #credits div:first-child {
                margin-bottom: 6px;
            }

        #size {
            width: 100%;
        }

        #draw-gradient {
            width: 100%;
        }
    language: css
libraries: |-
    https://appsforoffice.microsoft.com/lib/1/hosted/office.js
    https://raw.githubusercontent.com/DefinitelyTyped/DefinitelyTyped/master/types/office-js/index.d.ts
